{{define "branches-modal"}}
<!-- ì§€ì  ë‹¤ì¤‘ ì„ íƒ ëª¨ë‹¬ -->
<div id="branchesModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; display: flex; flex-direction: column;">
        <div class="modal-header" style="padding: 20px;">
            <h3>ì†Œì† ì§€ì  ì„ íƒ</h3>
            <span class="modal-close" onclick="closeBranchesModal()">&times;</span>
        </div>
        <div class="modal-body" style="padding: 0 20px; overflow-y: auto; flex: 1;">
            <div class="search-section" style="margin-bottom: 20px; padding-top: 10px;">
                <div class="search-filters" style="display: flex; align-items: center; gap: 10px;">
                    <select id="branchesSearchColumn" class="search-input" style="width: 150px; height: 40px; padding: 8px;">
                        <option value="name">ì§€ì ëª…</option>
                        <option value="alias">ë³„ì¹­</option>
                        <option value="address">ì£¼ì†Œ</option>
                    </select>
                    <input type="text" id="branchesSearch" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="search-input" style="flex: 1; height: 40px; padding: 8px;" onkeyup="filterBranches()">
                    <button class="btn-search" onclick="filterBranches()" style="height: 40px; white-space: nowrap; padding: 8px 16px;">ğŸ” ê²€ìƒ‰</button>
                </div>
            </div>
            
            <div class="table-wrapper" style="max-height: 350px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="text-align: center; width: 60px;">ì„ íƒ</th>
                            <th style="text-align: center">ì§€ì ëª…</th>
                            <th style="text-align: center">ë³„ì¹­</th>
                            <th style="text-align: center">ì£¼ì†Œ</th>
                        </tr>
                    </thead>
                    <tbody id="branchesList">
                        <tr data-name="ê°•ë‚¨ì " data-alias="gangnam" data-address="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬" data-id="BR001">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="ê°•ë‚¨ì " data-id="BR001" onchange="updateSelectedBranches()">
                            </td>
                            <td>ê°•ë‚¨ì </td>
                            <td>gangnam</td>
                            <td>ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</td>
                        </tr>
                        <tr data-name="í™ëŒ€ì " data-alias="hongdae" data-address="ì„œìš¸ì‹œ ë§ˆí¬êµ¬" data-id="BR002">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="í™ëŒ€ì " data-id="BR002" onchange="updateSelectedBranches()">
                            </td>
                            <td>í™ëŒ€ì </td>
                            <td>hongdae</td>
                            <td>ì„œìš¸ì‹œ ë§ˆí¬êµ¬</td>
                        </tr>
                        <tr data-name="ì‹ ì´Œì " data-alias="sinchon" data-address="ì„œìš¸ì‹œ ì„œëŒ€ë¬¸êµ¬" data-id="BR003">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="ì‹ ì´Œì " data-id="BR003" onchange="updateSelectedBranches()">
                            </td>
                            <td>ì‹ ì´Œì </td>
                            <td>sinchon</td>
                            <td>ì„œìš¸ì‹œ ì„œëŒ€ë¬¸êµ¬</td>
                        </tr>
                        <tr data-name="ì ì‹¤ì " data-alias="jamsil" data-address="ì„œìš¸ì‹œ ì†¡íŒŒêµ¬" data-id="BR004">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="ì ì‹¤ì " data-id="BR004" onchange="updateSelectedBranches()">
                            </td>
                            <td>ì ì‹¤ì </td>
                            <td>jamsil</td>
                            <td>ì„œìš¸ì‹œ ì†¡íŒŒêµ¬</td>
                        </tr>
                        <tr data-name="ê±´ëŒ€ì " data-alias="konkuk" data-address="ì„œìš¸ì‹œ ê´‘ì§„êµ¬" data-id="BR005">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="ê±´ëŒ€ì " data-id="BR005" onchange="updateSelectedBranches()">
                            </td>
                            <td>ê±´ëŒ€ì </td>
                            <td>konkuk</td>
                            <td>ì„œìš¸ì‹œ ê´‘ì§„êµ¬</td>
                        </tr>
                        <tr data-name="ì••êµ¬ì •ì " data-alias="apgujeong" data-address="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬" data-id="BR006">
                            <td style="text-align: center;">
                                <input type="checkbox" class="branch-checkbox" value="ì••êµ¬ì •ì " data-id="BR006" onchange="updateSelectedBranches()">
                            </td>
                            <td>ì••êµ¬ì •ì </td>
                            <td>apgujeong</td>
                            <td>ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination" style="margin-top: 20px;">
                <button class="page-btn" onclick="changeBranchPage('prev')">â—€</button>
                <button class="page-btn active" id="branch-page-1" onclick="changeBranchPage(1)">1</button>
                <button class="page-btn" id="branch-page-2" onclick="changeBranchPage(2)">2</button>
                <button class="page-btn" onclick="changeBranchPage('next')">â–¶</button>
            </div>
        </div>
        <div class="modal-footer" style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #666;">
                <span id="selectedCount">0</span>ê°œ ì§€ì  ì„ íƒë¨
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmBranchesSelection()">í™•ì¸</button>
                <button class="btn-modal-cancel" onclick="closeBranchesModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentBranchPage = 1;
    const branchItemsPerPage = 5;
    let selectedBranches = [];

    function openBranchesModal() {
        document.getElementById('branchesModal').style.display = 'flex';
        document.getElementById('branchesSearch').value = '';
        currentBranchPage = 1;
        
        // ê¸°ì¡´ ì„ íƒëœ ì§€ì  ë¶ˆëŸ¬ì˜¤ê¸°
        const currentValue = document.getElementById('branchesInput').value;
        selectedBranches = currentValue ? currentValue.split(', ').filter(b => b.trim()) : [];
        
        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
        document.querySelectorAll('.branch-checkbox').forEach(checkbox => {
            checkbox.checked = selectedBranches.includes(checkbox.value);
        });
        
        updateSelectedCount();
        filterBranches();
    }

    function closeBranchesModal() {
        document.getElementById('branchesModal').style.display = 'none';
    }

    function updateSelectedBranches() {
        selectedBranches = [];
        document.querySelectorAll('.branch-checkbox:checked').forEach(checkbox => {
            selectedBranches.push(checkbox.value);
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedBranches.length;
    }

    function confirmBranchesSelection() {
        document.getElementById('branchesInput').value = selectedBranches.join(', ');
        closeBranchesModal();
    }

    function filterBranches() {
        const searchValue = document.getElementById('branchesSearch').value.toLowerCase();
        const searchColumn = document.getElementById('branchesSearchColumn').value;
        const rows = document.querySelectorAll('#branchesList tr');
        let visibleRows = [];
        
        rows.forEach(row => {
            let fieldValue = '';
            if (searchColumn === 'name') {
                fieldValue = row.getAttribute('data-name').toLowerCase();
            } else if (searchColumn === 'alias') {
                fieldValue = row.getAttribute('data-alias').toLowerCase();
            } else if (searchColumn === 'address') {
                fieldValue = row.getAttribute('data-address').toLowerCase();
            }
            
            if (fieldValue.includes(searchValue)) {
                visibleRows.push(row);
            }
        });
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
        const totalPages = Math.ceil(visibleRows.length / branchItemsPerPage);
        const startIdx = (currentBranchPage - 1) * branchItemsPerPage;
        const endIdx = startIdx + branchItemsPerPage;
        
        rows.forEach(row => row.style.display = 'none');
        visibleRows.forEach((row, idx) => {
            if (idx >= startIdx && idx < endIdx) {
                row.style.display = '';
            }
        });
        
        updateBranchPagination(totalPages);
    }

    function changeBranchPage(page) {
        const rows = document.querySelectorAll('#branchesList tr');
        const searchValue = document.getElementById('branchesSearch').value.toLowerCase();
        const searchColumn = document.getElementById('branchesSearchColumn').value;
        let visibleCount = 0;
        
        rows.forEach(row => {
            let fieldValue = '';
            if (searchColumn === 'name') {
                fieldValue = row.getAttribute('data-name').toLowerCase();
            } else if (searchColumn === 'alias') {
                fieldValue = row.getAttribute('data-alias').toLowerCase();
            } else if (searchColumn === 'address') {
                fieldValue = row.getAttribute('data-address').toLowerCase();
            }
            
            if (fieldValue.includes(searchValue)) {
                visibleCount++;
            }
        });
        
        const totalPages = Math.ceil(visibleCount / branchItemsPerPage);
        
        if (page === 'prev') {
            if (currentBranchPage > 1) currentBranchPage--;
        } else if (page === 'next') {
            if (currentBranchPage < totalPages) currentBranchPage++;
        } else {
            currentBranchPage = page;
        }
        
        filterBranches();
    }

    function updateBranchPagination(totalPages) {
        const pageButtons = document.querySelectorAll('#branchesModal .pagination .page-btn');
        pageButtons.forEach(btn => {
            if (btn.id && btn.id.startsWith('branch-page-')) {
                const pageNum = parseInt(btn.id.split('-')[2]);
                if (pageNum <= totalPages) {
                    btn.style.display = '';
                    if (pageNum === currentBranchPage) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                } else {
                    btn.style.display = 'none';
                }
            }
        });
    }

    window.onclick = function(event) {
        const modal = document.getElementById('branchesModal');
        if (event.target === modal) {
            closeBranchesModal();
        }
    }
</script>
{{end}}
