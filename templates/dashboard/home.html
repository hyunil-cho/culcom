{{define "dashboard/home.html"}}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - ë°±ì˜¤í”¼ìŠ¤</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    {{template "sidebar" .}}
    
    <div class="main-wrapper">
        {{template "header" .}}
        
        <main class="content">
<!-- í†µê³„ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
<div class="stats-grid">
    {{range .Stats}}
    <div class="stat-card" style="border-left: 4px solid {{.Color}}">
        <div class="stat-icon">{{.Icon}}</div>
        <div class="stat-info">
            <div class="stat-title">{{.Title}}</div>
            <div class="stat-value">{{.Value}}</div>
        </div>
    </div>
    {{end}}
</div>

<!-- ì½˜í…ì¸  ì„¹ì…˜ -->
<div class="content-grid">
    <div class="content-card">
        <div class="card-header">
            <h3>ğŸ“ˆ ìµœê·¼ 7ì¼ ì˜ˆì•½ì ì¶”ì´</h3>
        </div>
        <div class="card-body">
            <canvas id="dailyStatsChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <div class="content-card">
        <div class="card-header">
            <h3>ğŸ“ CALLERë³„ ì˜ˆì•½ í™•ì • ë¹„ìœ¨</h3>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div style="display: flex; gap: 10px;">
                    <button class="period-btn active" data-period="day">ì¼ê°„</button>
                    <button class="period-btn" data-period="week">ì£¼ê°„</button>
                    <button class="period-btn" data-period="month">ì›”ê°„</button>
                </div>
                <div id="periodDateRange" style="font-size: 14px; color: #666; padding: 5px 0;">
                    ê¸°ê°„: <span id="dateRangeText">-</span>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="callerStatsContainer">
                <div style="text-align: center; padding: 40px; color: #999;">
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.content-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
    margin-top: 24px;
}

.period-btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    color: #666;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.period-btn:hover {
    background: #f5f5f5;
}

.period-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.caller-stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.caller-stats-table th,
.caller-stats-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.caller-stats-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.caller-stats-table tr:hover {
    background: #f8f9fa;
}

.rate-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.rate-progress {
    flex: 1;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.rate-fill {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #2ecc71);
    transition: width 0.3s ease;
}

.rate-text {
    font-weight: 600;
    color: #3498db;
    min-width: 60px;
    text-align: right;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// ì¼ë³„ í†µê³„ ë°ì´í„°
let dailyStatsData = [];
try {
    const rawData = '{{.DailyStatsJSON}}';
    dailyStatsData = JSON.parse(rawData);
    if (!Array.isArray(dailyStatsData)) {
        console.warn('dailyStatsData is not an array:', dailyStatsData);
        dailyStatsData = [];
    }
    console.log('ğŸ“Š ì¼ë³„ í†µê³„ ë°ì´í„°:', dailyStatsData);
} catch (e) {
    console.error('Failed to parse dailyStatsData:', e);
    dailyStatsData = [];
}

// Chart.js ê·¸ë˜í”„ ìƒì„±
const ctx = document.getElementById('dailyStatsChart');
if (ctx && dailyStatsData.length > 0) {
    // ë°ì´í„° ê°€ê³µ
    const labels = dailyStatsData.map(item => {
        const date = new Date(item.date);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}/${day}`;
    });
    
    const customerCounts = dailyStatsData.map(item => item.count);
    const reservationCounts = dailyStatsData.map(item => item.reservationCount);
    
    console.log('ğŸ“… ë‚ ì§œ ë¼ë²¨:', labels);
    console.log('ğŸ‘¥ ì˜ˆì•½ì ìˆ˜:', customerCounts);
    console.log('âœ… ì˜ˆì•½ í™•ì •ì ìˆ˜:', reservationCounts);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'ì˜ˆì•½ì ìˆ˜',
                    data: customerCounts,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                },
                {
                    label: 'ì˜ˆì•½ í™•ì •ì ìˆ˜',
                    data: reservationCounts,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#2ecc71',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            return label + ': ' + value + 'ëª…';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value + 'ëª…';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
} else if (ctx && dailyStatsData.length === 0) {
    // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
    ctx.parentElement.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #999;">ìµœê·¼ 7ì¼ê°„ ì˜ˆì•½ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
}

// CALLERë³„ í†µê³„ ê´€ë¦¬
let currentPeriod = 'day';

// ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYY-MM-DD)
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ê¸°ê°„ë³„ ë‚ ì§œ ë²”ìœ„ ê³„ì‚° ë° í‘œì‹œ
function updateDateRange(period) {
    const today = new Date();
    const dateRangeElement = document.getElementById('dateRangeText');
    
    let dateText = '';
    
    switch(period) {
        case 'day':
            dateText = formatDate(today);
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - 6);
            dateText = `${formatDate(weekStart)} ~ ${formatDate(today)}`;
            break;
        case 'month':
            const monthStart = new Date(today);
            monthStart.setDate(today.getDate() - 29);
            dateText = `${formatDate(monthStart)} ~ ${formatDate(today)}`;
            break;
    }
    
    dateRangeElement.textContent = dateText;
}

// CALLERë³„ í†µê³„ ë¡œë“œ í•¨ìˆ˜
async function loadCallerStats(period) {
    const container = document.getElementById('callerStatsContainer');
    
    try {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        const response = await fetch(`/api/dashboard/caller-stats?period=${period}`);
        if (!response.ok) {
            throw new Error('Failed to fetch caller stats');
        }
        
        const callerStats = await response.json();
        console.log('ğŸ“ CALLERë³„ í†µê³„:', callerStats);
        
        if (!callerStats || callerStats.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">í•´ë‹¹ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        // í…Œì´ë¸” ìƒì„±
        let tableHTML = `
            <table class="caller-stats-table">
                <thead>
                    <tr>
                        <th>CALLER</th>
                        <th>ì„ íƒ íšŸìˆ˜</th>
                        <th>ì˜ˆì•½ í™•ì • ìˆ˜</th>
                        <th>í™•ì • ë¹„ìœ¨</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        callerStats.forEach(stat => {
            tableHTML += `
                <tr>
                    <td><strong>${stat.Caller || 'N/A'}</strong></td>
                    <td>${stat.SelectionCount || 0}íšŒ</td>
                    <td>${stat.ReservationConfirm}ëª…</td>
                    <td>
                        <div class="rate-bar">
                            <div class="rate-progress">
                                <div class="rate-fill" style="width: ${stat.ConfirmRate}%"></div>
                            </div>
                            <span class="rate-text">${stat.ConfirmRate.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = tableHTML;
        
    } catch (error) {
        console.error('Error loading caller stats:', error);
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

// ê¸°ê°„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // ëª¨ë“  ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        
        // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
        this.classList.add('active');
        
        // ì„ íƒëœ ê¸°ê°„ìœ¼ë¡œ í†µê³„ ë¡œë“œ
        const period = this.dataset.period;
        currentPeriod = period;
        
        // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
        updateDateRange(period);
        
        // í†µê³„ ë°ì´í„° ë¡œë“œ
        loadCallerStats(period);
    });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // ì´ˆê¸° ë‚ ì§œ ë²”ìœ„ í‘œì‹œ
    updateDateRange(currentPeriod);
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadCallerStats(currentPeriod);
});

</script>
        </main>
    </div>
</body>
</html>
{{end}}
